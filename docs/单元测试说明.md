# 单元测试说明

## 测试文件位置

在 Go 项目中，测试文件遵循以下约定：

1. **测试文件命名**：`*_test.go`（与源文件在同一目录）
2. **测试函数命名**：`TestXxx`（Xxx 必须以大写字母开头）
3. **测试文件位置**：与源文件放在同一个包中

## 项目测试结构

```
internal/
├── repository/
│   ├── user_repository.go          # 源文件
│   └── user_repository_test.go     # 测试文件
├── service/
│   ├── user_service.go             # 源文件
│   └── user_service_test.go        # 测试文件
└── api/
    └── handlers/
        ├── user.go                 # 源文件
        └── user_test.go            # 测试文件
```

## 测试策略

### 1. Repository 层测试（数据访问层）

**特点：**
- 使用**真实的 SQLite 内存数据库**（`:memory:`）
- 测试真实的数据库操作
- 每个测试都创建独立的数据库实例

**测试内容：**
- ✅ 创建用户（包括重复邮箱检查）
- ✅ 根据ID查找用户
- ✅ 根据邮箱查找用户
- ✅ 查找所有用户
- ✅ 更新用户
- ✅ 删除用户
- ✅ 完整的 CRUD 集成测试

**示例：**
```go
func TestUserRepository_Create(t *testing.T) {
    db := setupTestDB(t)  // 创建内存数据库
    defer teardownTestDB(t, db)  // 清理
    
    repo := NewUserRepository(db)
    // 测试代码...
}
```

### 2. Service 层测试（业务逻辑层）

**特点：**
- 使用 **Mock Repository**（不依赖真实数据库）
- 测试业务逻辑（验证、转换等）
- 快速执行，无需数据库

**测试内容：**
- ✅ 创建用户（邮箱唯一性检查）
- ✅ 获取用户（参数验证）
- ✅ 更新用户（邮箱重复检查）
- ✅ 删除用户（存在性检查）

**示例：**
```go
func TestUserService_CreateUser(t *testing.T) {
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    
    // 设置 Mock 期望
    mockRepo.On("FindByEmail", ctx, email).Return(nil, errors.New("不存在"))
    mockRepo.On("Create", ctx, user).Return(expectedUser, nil)
    
    // 执行测试
    user, err := service.CreateUser(ctx, req)
    
    // 验证结果
    require.NoError(t, err)
    mockRepo.AssertExpectations(t)
}
```

### 3. Handler 层测试（控制器层）

**特点：**
- 使用 **Mock Service**（不依赖业务逻辑）
- 测试 HTTP 请求/响应
- 使用 `httptest` 包模拟 HTTP 请求

**测试内容：**
- ✅ 创建用户 API
- ✅ 获取用户 API
- ✅ 获取所有用户 API
- ✅ 更新用户 API
- ✅ 删除用户 API
- ✅ 请求参数验证

**示例：**
```go
func TestUserHandler_CreateUser(t *testing.T) {
    mockService := new(MockUserService)
    handler := NewUserHandler(mockService)
    router := setupTestRouter(handler)
    
    // 创建 HTTP 请求
    req := httptest.NewRequest(http.MethodPost, "/api/v1/users", body)
    w := httptest.NewRecorder()
    
    // 执行请求
    router.ServeHTTP(w, req)
    
    // 验证响应
    assert.Equal(t, http.StatusCreated, w.Code)
}
```

## 运行测试

### 运行所有测试
```bash
# 运行所有测试
go test ./...

# 运行特定包的测试
go test ./internal/repository/...
go test ./internal/service/...
go test ./internal/api/handlers/...
```

### 运行测试（详细输出）
```bash
go test ./... -v
```

### 运行测试（显示覆盖率）
```bash
# 生成覆盖率报告
go test ./... -cover

# 生成详细的覆盖率报告
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out
```

### 运行特定测试
```bash
# 运行特定测试函数
go test ./internal/service -run TestUserService_CreateUser

# 运行匹配模式的测试
go test ./internal/service -run TestUserService
```

## 测试工具

### 使用的测试库

1. **testing** - Go 标准测试库
2. **testify/assert** - 断言库
3. **testify/require** - 必须断言（失败时立即停止）
4. **testify/mock** - Mock 对象库

### 安装依赖
```bash
go get github.com/stretchr/testify/assert
go get github.com/stretchr/testify/require
go get github.com/stretchr/testify/mock
```

## 测试最佳实践

### 1. 测试命名
- 测试函数：`TestXxx`
- 子测试：使用 `t.Run("描述", func(t *testing.T) {...})`

### 2. 测试结构
```go
func TestXxx(t *testing.T) {
    // Arrange（准备）
    setup()
    
    // Act（执行）
    result := function()
    
    // Assert（断言）
    assert.Equal(t, expected, result)
}
```

### 3. 测试隔离
- 每个测试应该独立运行
- 使用 `setup` 和 `teardown` 函数
- Repository 测试使用内存数据库

### 4. Mock 使用
- Service 层测试 Mock Repository
- Handler 层测试 Mock Service
- 验证 Mock 的调用：`mock.AssertExpectations(t)`

### 5. 测试覆盖率
- 目标覆盖率：> 70%
- 关键业务逻辑：> 90%
- 使用 `go test -cover` 查看覆盖率

## 测试示例

### Repository 测试示例
```go
func TestUserRepository_Create(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewUserRepository(db)
    ctx := context.Background()
    
    user := &models.User{
        Name:  "张三",
        Email: "zhangsan@example.com",
        Age:   25,
    }
    
    created, err := repo.Create(ctx, user)
    require.NoError(t, err)
    assert.NotZero(t, created.ID)
}
```

### Service 测试示例
```go
func TestUserService_CreateUser(t *testing.T) {
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    
    req := &models.CreateUserRequest{
        Name:  "张三",
        Email: "zhangsan@example.com",
        Age:   25,
    }
    
    mockRepo.On("FindByEmail", ctx, req.Email).Return(nil, errors.New("不存在"))
    mockRepo.On("Create", ctx, mock.Anything).Return(expectedUser, nil)
    
    user, err := service.CreateUser(ctx, req)
    require.NoError(t, err)
    mockRepo.AssertExpectations(t)
}
```

### Handler 测试示例
```go
func TestUserHandler_CreateUser(t *testing.T) {
    mockService := new(MockUserService)
    handler := NewUserHandler(mockService)
    router := setupTestRouter(handler)
    
    reqBody := models.CreateUserRequest{...}
    body, _ := json.Marshal(reqBody)
    
    req := httptest.NewRequest(http.MethodPost, "/api/v1/users", bytes.NewBuffer(body))
    req.Header.Set("Content-Type", "application/json")
    w := httptest.NewRecorder()
    
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusCreated, w.Code)
}
```

## 常见问题

### 1. 测试数据库连接失败
- 确保 SQLite 驱动已安装：`go get github.com/mattn/go-sqlite3`
- 使用内存数据库：`":memory:"`

### 2. Mock 未调用
- 检查 Mock 期望设置是否正确
- 使用 `mock.AssertExpectations(t)` 验证

### 3. 测试数据污染
- 每个测试使用独立的数据库实例
- 使用 `defer teardownTestDB(t, db)` 清理

## 下一步

1. **集成测试**：测试完整的请求-响应流程
2. **性能测试**：使用 `testing.B` 进行基准测试
3. **测试覆盖率**：达到 70%+ 覆盖率
4. **CI/CD 集成**：在 CI 中自动运行测试
