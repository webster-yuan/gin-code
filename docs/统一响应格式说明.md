# 统一响应格式说明

## 概述

项目已实现统一的 API 响应格式，所有 API 接口都使用相同的响应结构，便于前端统一处理和错误排查。

## 响应结构

### 成功响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体数据
  },
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 错误响应

```json
{
  "code": 400,
  "message": "请求参数错误",
  "error": "请求参数错误",
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

## 字段说明

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| `code` | int | HTTP 状态码（与业务状态码一致） | ✅ |
| `message` | string | 消息描述 | ✅ |
| `data` | object | 数据内容（成功时返回） | ❌ |
| `error` | string | 错误信息（失败时返回） | ❌ |
| `timestamp` | int64 | Unix 时间戳（秒） | ✅ |
| `request_id` | string | 请求ID（用于追踪） | ❌ |

## 使用方式

### 在 Handler 中使用

```go
import "gin/internal/api/response"

// 成功响应
func (h *UserHandler) GetUser() gin.HandlerFunc {
    return func(c *gin.Context) {
        user, err := h.userService.GetUserByID(ctx, id)
        if err != nil {
            c.Error(err)  // 交给错误中间件处理
            return
        }
        
        // 使用统一响应格式
        response.Success(c, "获取成功", user)
    }
}

// 创建成功（201）
func (h *UserHandler) CreateUser() gin.HandlerFunc {
    return func(c *gin.Context) {
        user, err := h.userService.CreateUser(ctx, &req)
        if err != nil {
            c.Error(err)
            return
        }
        
        response.Created(c, "创建成功", user)
    }
}

// 无内容（204）
func (h *UserHandler) DeleteUser() gin.HandlerFunc {
    return func(c *gin.Context) {
        err := h.userService.DeleteUser(ctx, id)
        if err != nil {
            c.Error(err)
            return
        }
        
        response.NoContent(c)
    }
}
```

### 错误处理

错误会自动通过错误中间件转换为统一格式：

```go
// 在 Service 或 Handler 中
if err != nil {
    return nil, errors.NewBadRequestError("参数错误", err)
}

// 在 Handler 中
if err != nil {
    c.Error(err)  // 自动转换为统一错误响应
    return
}
```

## 响应函数

### 成功响应函数

```go
// 标准成功响应（200）
response.Success(c, "操作成功", data)

// 自定义状态码的成功响应
response.SuccessWithCode(c, http.StatusAccepted, "已接受", data)

// 创建成功（201）
response.Created(c, "创建成功", data)

// 无内容（204）
response.NoContent(c)
```

### 错误响应函数

```go
// 通用错误响应
response.Error(c, http.StatusBadRequest, "参数错误", err)

// 常用错误响应
response.BadRequest(c, "参数错误", err)           // 400
response.Unauthorized(c, "未授权", err)          // 401
response.Forbidden(c, "禁止访问", err)            // 403
response.NotFound(c, "资源不存在", err)            // 404
response.InternalServerError(c, "服务器错误", err) // 500
```

## 请求ID

每个请求都会自动生成唯一的请求ID，用于：

1. **日志追踪**：在日志中关联请求ID，便于排查问题
2. **问题定位**：通过请求ID快速定位特定请求的所有日志
3. **分布式追踪**：在微服务架构中追踪请求链路

### 获取请求ID

请求ID会自动添加到响应头：

```
X-Request-ID: 550e8400-e29b-41d4-a716-446655440000
```

客户端也可以在请求头中提供请求ID：

```
X-Request-ID: your-custom-request-id
```

## 响应示例

### 创建用户成功

**请求：**
```bash
POST /api/v1/users
Content-Type: application/json

{
  "name": "张三",
  "email": "zhangsan@example.com",
  "age": 25
}
```

**响应：**
```json
{
  "code": 201,
  "message": "创建成功",
  "data": {
    "id": 1,
    "name": "张三",
    "email": "zhangsan@example.com",
    "age": 25,
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-15T10:30:00Z"
  },
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 获取用户成功

**请求：**
```bash
GET /api/v1/users/1
```

**响应：**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "email": "zhangsan@example.com",
    "age": 25
  },
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 用户不存在

**请求：**
```bash
GET /api/v1/users/999
```

**响应：**
```json
{
  "code": 404,
  "message": "用户不存在",
  "error": "用户不存在",
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 参数验证失败

**请求：**
```bash
POST /api/v1/users
Content-Type: application/json

{
  "name": "",
  "email": "invalid-email"
}
```

**响应：**
```json
{
  "code": 400,
  "message": "请求参数错误",
  "error": "请求参数错误",
  "timestamp": 1705123456,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

## 优势

1. **统一格式**：所有 API 使用相同的响应结构
2. **易于处理**：前端可以统一处理响应
3. **便于调试**：请求ID和时间戳便于问题排查
4. **标准化**：符合 RESTful API 最佳实践
5. **类型安全**：使用结构体确保类型安全

## 注意事项

1. **错误处理**：使用 `c.Error(err)` 让错误中间件统一处理
2. **状态码**：`code` 字段与 HTTP 状态码保持一致
3. **数据字段**：成功时使用 `data`，失败时使用 `error`
4. **请求ID**：自动生成，无需手动处理
5. **时间戳**：自动添加，Unix 时间戳（秒）

## 迁移指南

### 旧代码

```go
c.JSON(http.StatusOK, gin.H{
    "code":    200,
    "message": "success",
    "data":    user,
})
```

### 新代码

```go
response.Success(c, "获取成功", user)
```

更简洁、更统一！
