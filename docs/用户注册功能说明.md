# 用户注册功能说明

## 概述

项目已实现用户注册功能，允许新用户通过公开的API接口注册账户。注册功能不需要认证，任何用户都可以创建新账户。

## 实现方案

### 技术栈

- **bcrypt**：用于密码哈希和验证
- **Gin框架**：处理HTTP请求和响应
- **三层架构**：Handler → Service → Repository
- **国际化（i18n）**：支持多语言消息

### 核心组件

| 组件 | 路径 | 功能 |
|------|------|------|
| 注册处理器 | `internal/api/handlers/user.go` | 处理注册HTTP请求 |
| 用户服务 | `internal/service/user_service.go` | 用户注册业务逻辑 |
| 用户仓库 | `internal/repository/user_repository.go` | 数据访问层 |
| 密码工具 | `internal/auth/password.go` | 密码哈希处理 |
| 国际化 | `internal/i18n/i18n.go` | 注册成功消息 |

## 注册流程

1. 用户提交注册信息（姓名、邮箱、密码、年龄）
2. 系统验证请求参数（邮箱格式、密码长度等）
3. 检查邮箱是否已存在（避免重复注册）
4. 使用bcrypt算法对密码进行哈希处理
5. 将用户信息存储到数据库
6. 返回注册成功的响应（不包含密码字段）

## API接口

### 用户注册

```
POST /api/v1/auth/register
Content-Type: application/json
```

**请求体：**

```json
{
  "name": "测试用户",
  "email": "test@example.com",
  "password": "123456",
  "age": 25
}
```

**请求参数说明：**

| 参数 | 类型 | 必填 | 说明 | 验证规则 |
|------|------|------|------|----------|
| name | string | ✅ | 用户姓名 | 必填，2-50个字符 |
| email | string | ✅ | 用户邮箱 | 必填，有效的邮箱格式 |
| password | string | ✅ | 用户密码 | 必填，最少6个字符 |
| age | int | ❌ | 用户年龄 | 可选，0-150之间 |

**成功响应（201 Created）：**

```json
{
  "code": 201,
  "message": "注册成功",
  "data": {
    "id": 1,
    "name": "测试用户",
    "email": "test@example.com",
    "age": 25,
    "created_at": "2026-01-18T15:19:00Z",
    "updated_at": "2026-01-18T15:19:00Z"
  },
  "timestamp": 1768662000,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**错误响应（400 Bad Request）：**

```json
{
  "code": 400,
  "message": "邮箱已被使用",
  "timestamp": 1768662000,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

## 使用方式

### 在路由中配置

注册路由已配置在 `/api/v1/auth` 路由组中，**不需要认证**：

```go
// internal/api/routes.go
// 认证路由（不需要认证）
auth := apiGroup.Group("/auth")
{
    auth.POST("/register", userHandler.Register()) // POST /api/v1/auth/register
    auth.POST("/login", userHandler.Login())       // POST /api/v1/auth/login
}
```

### 代码实现

#### Handler层

```go
// internal/api/handlers/user.go
func (h *UserHandler) Register() gin.HandlerFunc {
    return func(c *gin.Context) {
        var req models.CreateUserRequest
        if err := c.ShouldBindJSON(&req); err != nil {
            c.Error(err)
            return
        }

        user, err := h.userService.CreateUser(c.Request.Context(), &req)
        if err != nil {
            c.Error(err)
            return
        }

        response.Created(c, i18n.UserMessage(i18n.UserRegisterSuccess), user)
    }
}
```

#### Service层

```go
// internal/service/user_service.go
func (s *userService) CreateUser(ctx context.Context, req *models.CreateUserRequest) (*models.User, error) {
    // 1. 检查邮箱是否已存在
    _, err := s.userRepo.FindByEmail(ctx, req.Email)
    if err == nil {
        return nil, errors.NewBadRequestError("邮箱已被使用", ...)
    }

    // 2. 加密密码
    hashedPassword, err := auth.HashPassword(req.Password)
    if err != nil {
        return nil, errors.NewInternalServerError("密码加密失败", err)
    }

    // 3. 创建用户
    user := &models.User{
        Name:     req.Name,
        Email:    req.Email,
        Password: hashedPassword,
        Age:      req.Age,
    }

    return s.userRepo.Create(ctx, user)
}
```

## 安全特性

### 1. 密码安全

- **bcrypt哈希**：使用bcrypt算法对密码进行哈希处理
- **自动盐值**：bcrypt自动生成唯一盐值
- **密码不返回**：响应中不包含密码字段

### 2. 数据验证

- **参数验证**：使用Gin的binding标签验证请求参数
- **邮箱唯一性**：检查邮箱是否已存在
- **格式验证**：验证邮箱格式、密码长度等

### 3. 错误处理

- **统一错误格式**：使用统一的错误响应格式
- **国际化消息**：支持多语言错误消息

## 错误处理

### 错误类型

| 错误类型 | 状态码 | 错误信息 | 说明 |
|----------|--------|----------|------|
| 参数验证错误 | 400 | "请求参数错误" | 请求参数不符合验证规则 |
| 邮箱已被使用 | 400 | "邮箱已被使用" | 邮箱已存在于系统中 |
| 密码加密失败 | 500 | "密码加密失败" | 密码哈希处理失败 |
| 数据库错误 | 500 | "内部服务器错误" | 数据库操作失败 |

### 错误响应示例

```json
{
  "code": 400,
  "message": "请求参数错误",
  "timestamp": 1768662000,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

## 测试

### 1. 测试注册成功

#### Linux/macOS (curl)

```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{"name":"测试用户","email":"test@example.com","password":"123456","age":25}' \
  http://localhost:8080/api/v1/auth/register
```

#### Windows (PowerShell)

```powershell
Invoke-WebRequest -Uri http://localhost:8080/api/v1/auth/register `
  -Method POST `
  -Headers @{"Content-Type"="application/json"} `
  -Body '{"name":"测试用户","email":"test@example.com","password":"123456","age":25}'
```

**期待结果：**
- 状态码：201 Created
- 响应包含用户信息（不含密码）

### 2. 测试重复邮箱

```bash
# 第一次注册
curl -X POST -H "Content-Type: application/json" \
  -d '{"name":"用户1","email":"duplicate@example.com","password":"123456","age":25}' \
  http://localhost:8080/api/v1/auth/register

# 第二次注册（相同邮箱）
curl -X POST -H "Content-Type: application/json" \
  -d '{"name":"用户2","email":"duplicate@example.com","password":"123456","age":30}' \
  http://localhost:8080/api/v1/auth/register
```

**期待结果：**
- 第一次：201 Created
- 第二次：400 Bad Request（"邮箱已被使用"）

### 3. 测试参数验证

```bash
# 无效的邮箱格式
curl -X POST -H "Content-Type: application/json" \
  -d '{"name":"测试用户","email":"invalid-email","password":"123456","age":25}' \
  http://localhost:8080/api/v1/auth/register

# 密码太短
curl -X POST -H "Content-Type: application/json" \
  -d '{"name":"测试用户","email":"test@example.com","password":"123","age":25}' \
  http://localhost:8080/api/v1/auth/register
```

**期待结果：**
- 状态码：400 Bad Request
- 错误信息："请求参数错误"

## Swagger测试

### 访问Swagger页面

1. 启动服务器：
   ```bash
   go run cmd/server/main.go server
   ```

2. 打开Swagger页面：
   ```
   http://localhost:8080/swagger/index.html
   ```

3. 找到 `auth` 标签下的 `POST /api/v1/auth/register` 接口

4. 点击 "Try it out" 按钮

5. 填写请求体：
   ```json
   {
     "name": "测试用户",
     "email": "test@example.com",
     "password": "123456",
     "age": 25
   }
   ```

6. 点击 "Execute" 执行

7. 查看响应结果

### Swagger界面说明

- **Summary**：用户注册
- **Description**：用户注册新账户
- **Tags**：auth（认证相关）
- **Parameters**：`register` 参数（请求体）
- **Responses**：
  - `201`：注册成功
  - `400`：请求参数错误或邮箱已被使用
  - `500`：服务器内部错误

## 与其他功能的集成

### 1. 国际化（i18n）

注册功能使用国际化消息：

```go
// 使用国际化消息
response.Created(c, i18n.UserMessage(i18n.UserRegisterSuccess), user)
```

- **日志消息**：使用英文（通过i18n.LogMessage）
- **API响应**：使用中文（通过i18n.UserMessage，默认）

### 2. 统一响应格式

注册功能使用统一的响应格式：

```json
{
  "code": 201,
  "message": "注册成功",
  "data": { ... },
  "timestamp": 1768662000,
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### 3. 错误处理

注册功能的错误通过统一的错误处理中间件处理：

```go
// 错误自动转换为统一格式
if err != nil {
    c.Error(err)  // 交给错误中间件处理
    return
}
```

## 与登录功能的对比

| 特性 | 注册（Register） | 登录（Login） |
|------|----------------|--------------|
| **路由** | `/api/v1/auth/register` | `/api/v1/auth/login` |
| **认证** | ❌ 不需要 | ❌ 不需要 |
| **请求体** | `CreateUserRequest`（name, email, password, age） | `LoginRequest`（email, password） |
| **业务逻辑** | 创建用户，检查邮箱唯一性 | 验证邮箱和密码，生成JWT |
| **响应** | 返回用户信息 | 返回用户信息和JWT令牌 |
| **状态码** | 201 Created | 200 OK |

## 最佳实践

### 1. 密码安全

- ✅ 使用bcrypt哈希密码
- ✅ 密码长度至少6个字符
- ✅ 响应中不包含密码字段

### 2. 数据验证

- ✅ 验证所有必填字段
- ✅ 验证邮箱格式
- ✅ 检查邮箱唯一性
- ✅ 验证密码长度

### 3. 错误处理

- ✅ 使用统一的错误响应格式
- ✅ 提供明确的错误消息
- ✅ 记录错误日志（英文）

### 4. 代码组织

- ✅ 复用现有业务逻辑（CreateUser）
- ✅ 使用国际化消息
- ✅ 遵循三层架构原则

## 注意事项

1. **邮箱唯一性**：系统会检查邮箱是否已存在，重复邮箱会返回400错误
2. **密码安全**：密码会使用bcrypt哈希后存储，永远不会以明文形式保存
3. **不需要认证**：注册接口是公开的，不需要JWT令牌
4. **响应不包含密码**：注册成功响应中不包含密码字段
5. **参数验证**：所有请求参数都会经过验证，不符合规则的请求会返回400错误

## 文件清单

### 核心文件

- `internal/api/handlers/user.go` - 注册处理器
- `internal/service/user_service.go` - 注册业务逻辑（复用CreateUser）
- `internal/repository/user_repository.go` - 数据访问层
- `internal/api/routes.go` - 注册路由配置
- `internal/i18n/i18n.go` - 注册成功消息

### 相关文件

- `internal/models/user.go` - 用户模型和请求结构
- `internal/auth/password.go` - 密码哈希工具
- `internal/errors/errors.go` - 错误处理

## 总结

用户注册功能实现了：

1. ✅ **公开接口**：不需要认证即可注册
2. ✅ **安全处理**：使用bcrypt哈希密码
3. ✅ **数据验证**：完整的参数验证和邮箱唯一性检查
4. ✅ **统一格式**：使用统一的响应格式和错误处理
5. ✅ **国际化**：支持多语言消息
6. ✅ **Swagger支持**：完整的API文档支持

注册功能与登录功能配合，构成了完整的用户认证体系。用户可以先注册账户，然后使用注册的邮箱和密码登录获取JWT令牌。
